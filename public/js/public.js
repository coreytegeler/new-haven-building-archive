// Generated by CoffeeScript 1.10.0
(function() {
  $(function() {
    var $buildingMap, $buildingWrap, $buildings, $main, constrainArray, getData, handleBuildings, hoverBuilding, init, initMap, openBuilding, resizeMap, selectBuilding, unhoverBuilding;
    $main = $('main');
    $buildingWrap = $('.mapWrap.buildings');
    $buildingMap = $('.map.buildings');
    $buildings = $('.building');
    init = function() {
      $buildingMap.masonry({
        transitionDuration: 0
      });
      resizeMap();
      $(window).resize(resizeMap);
      handleBuildings();
      return $buildingMap.pep({
        useCSSTranslation: false,
        constrainTo: constrainArray(),
        start: function(event) {
          $buildingMap.addClass('dragged');
          return $buildingMap.addClass('dragging');
        },
        stop: function() {
          return $buildingMap.removeClass('dragging');
        }
      });
    };
    constrainArray = function() {
      var hDiff, wDiff;
      wDiff = $buildingMap.width() - $buildingWrap.innerWidth();
      hDiff = $buildingMap.height() - $buildingWrap.innerHeight();
      return [-hDiff, 0, 0, -wDiff];
    };
    resizeMap = function() {
      var $window, edge, height, larger, left, length, smaller, top, width;
      $window = $(window);
      length = $buildings.length;
      smaller = Math.floor(Math.sqrt(length));
      larger = Math.round(Math.sqrt(length));
      edge = $buildings.eq(0).innerWidth();
      width = larger * edge;
      height = smaller * edge;
      $buildingMap.css({
        width: width + 'px',
        height: height + 'px'
      });
      $buildingMap.masonry('layout');
      if (!$buildingMap.is('.dragged')) {
        width = $buildingMap.width();
        height = $buildingMap.height();
        left = $buildingWrap.innerWidth() / 2 - width / 2;
        top = $buildingWrap.innerHeight() / 2 - height / 2;
        $buildingMap.css({
          left: left,
          top: top
        });
      }
    };
    handleBuildings = function() {
      $('body').on('mouseenter', '.building a', function() {
        return hoverBuilding(this);
      });
      $('body').on('mouseleave', '.building a', function() {
        return unhoverBuilding(this);
      });
      return $('body').on('click', '.building a', function() {
        return selectBuilding(this);
      });
    };
    hoverBuilding = function(self) {
      var $building, parent, slug;
      parent = $(self).parents('.building')[0];
      slug = parent.dataset.slug;
      $building = $('.building[data-slug="' + slug + '"]');
      return $building.addClass('hover');
    };
    unhoverBuilding = function(self) {
      var $building, parent, slug;
      parent = $(self).parents('.building')[0];
      slug = parent.dataset.slug;
      $building = $('.building[data-slug="' + slug + '"]');
      return $building.removeClass('hover');
    };
    selectBuilding = function(self) {
      var $building, parent, slug, type, url;
      event.preventDefault();
      if ($buildingMap.is('.dragging')) {
        return;
      }
      parent = $(self).parents('.building')[0];
      slug = parent.dataset.slug;
      type = parent.dataset.type;
      url = self.href;
      $building = $('.building[data-slug="' + slug + '"]');
      if (!$building) {
        return;
      }
      $('.building.selected').removeClass('selected');
      $building.addClass('selected');
      openBuilding(slug, type);
      return window.history.pushState('', document.title, url);
    };
    openBuilding = function(slug, type) {
      var $panel;
      $panel = $('.buildingPanel');
      $main.addClass('opened');
      $panel.addClass('loading');
      return getData(slug, type, $panel);
    };
    getData = function(slug, type, container) {
      console.log(slug, type);
      $(container).addClass('show loading');
      $.ajax({
        url: '/api/' + type + '/' + slug + '/html',
        error: function(jqXHR, status, error) {
          console.log(jqXHR, status, error);
        },
        success: function(response, status, jqXHR) {
          $(container).html(response);
          $(container).removeClass('loading');
          if ($(response).find('#gMapWrap')) {
            return initMap(container);
          }
        }
      });
    };
    initMap = function(container) {
      var address, gMap, gMapWrap, geocoder;
      address = $(container).find('.address').text() + ', New Haven, CT 06510';
      gMapWrap = $(container).find('.gMapWrap')[0];
      geocoder = new google.maps.Geocoder();
      gMap = new google.maps.Map(gMapWrap, {
        center: {
          lat: -34.397,
          lng: 150.644
        },
        zoom: 16
      });
      return geocoder.geocode({
        'address': address
      }, function(results, status) {
        var marker;
        if (status === 'OK') {
          gMap.setCenter(results[0].geometry.location);
          return marker = new google.maps.Marker({
            map: gMap,
            position: results[0].geometry.location
          });
        }
      });
    };
    return init();
  });

}).call(this);
